<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="reverse engineering/decompilation, mathematical analysis, and exploitation of Vigenere Cisco algorithm Identify: In this course we are going to learn what to do when we do not have the source code of a program but when we need to still read the source code in order to find vulnerabilities that the developpers have let.
You will have to use this code reading technic (reverse engineering) to audit a proprietary hashing algorithm known as &ldquo;Vigenere Cisco&rdquo;.
"><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://gogo2464.github.io/gogo-s-blog-cpe/from-0-to-buffer-overflow-by-projects/episode-2-guessing-source-code-reverse-engineering-program/><title>Episode 2: guessing source-code (reverse engineering) of an cryptographic algorithm to break it :: CPE — CPE: the school that schools to send you to cpe!
</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/gogo-s-blog-cpe/main.d7ff2d2210fd0ab14f417c6d91d2931b4ecffab189943b30890ff820a24a57c9.css><script src=https://kit.fontawesome.com/0ed5cec925.js crossorigin=anonymous></script><link rel=apple-touch-icon sizes=180x180 href=/gogo-s-blog-cpe/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/gogo-s-blog-cpe/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/gogo-s-blog-cpe/favicon-16x16.png><link rel=manifest href=/gogo-s-blog-cpe/site.webmanifest><link rel=mask-icon href=/gogo-s-blog-cpe/safari-pinned-tab.svg color><link rel="shortcut icon" href=/gogo-s-blog-cpe/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Episode 2: guessing source-code (reverse engineering) of an cryptographic algorithm to break it"><meta itemprop=description content="reverse engineering/decompilation, mathematical analysis, and exploitation of Vigenere Cisco algorithm Identify: In this course we are going to learn what to do when we do not have the source code of a program but when we need to still read the source code in order to find vulnerabilities that the developpers have let.
You will have to use this code reading technic (reverse engineering) to audit a proprietary hashing algorithm known as “Vigenere Cisco”."><meta itemprop=datePublished content="2024-10-12T23:00:00+02:00"><meta itemprop=dateModified content="2024-10-12T23:00:00+02:00"><meta itemprop=wordCount content="2752"><meta itemprop=image content="https://gogo2464.github.io/gogo-s-blog-cpe/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gogo2464.github.io/gogo-s-blog-cpe/"><meta name=twitter:title content="Episode 2: guessing source-code (reverse engineering) of an cryptographic algorithm to break it"><meta name=twitter:description content="reverse engineering/decompilation, mathematical analysis, and exploitation of Vigenere Cisco algorithm Identify: In this course we are going to learn what to do when we do not have the source code of a program but when we need to still read the source code in order to find vulnerabilities that the developpers have let.
You will have to use this code reading technic (reverse engineering) to audit a proprietary hashing algorithm known as “Vigenere Cisco”."><meta property="article:published_time" content="2024-10-12 23:00:00 +0200 +0200"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css integrity=sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+ crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js integrity=sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js integrity=sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})'></script></head><body><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script><div class=container><header class=header><span class=header__inner><a href=/gogo-s-blog-cpe style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>crypto-pwn-elite(cpe): courses</span>
<span class=logo__cursor style=background-color:#fff></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><div class=submenu><li class=dropdown><a href=/gogo-s-blog-cpe/from-0-to-crypto-by-projects>Crypto</a></li></div><div class=submenu><li class=dropdown><a href=/gogo-s-blog-cpe/from-0-to-buffer-overflow-by-projects>Pwn</a></li></div><div class=submenu><li class=dropdown><a href=/gogo-s-blog-cpe/putting-games-on-darknet>Elite</a></li></div></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://gogo2464.github.io/gogo-s-blog-cpe/from-0-to-buffer-overflow-by-projects/episode-2-guessing-source-code-reverse-engineering-program/>Episode 2: guessing source-code (reverse engineering) of an cryptographic algorithm to break it</a></h2><div class=post-content><h3 id=reverse-engineeringdecompilation-mathematical-analysis-and-exploitation-of-vigenere-cisco-algorithm>reverse engineering/decompilation, mathematical analysis, and exploitation of Vigenere Cisco algorithm</h3><h2 id=identify>Identify:</h2><p>In this course we are going to learn what to do when we do not have the source code of a program but when we need to still read the source code in order to find vulnerabilities that the developpers have let.</p><p>You will have to use this code reading technic (reverse engineering) to audit a proprietary hashing algorithm known as &ldquo;Vigenere Cisco&rdquo;.</p><p>Trought the main goal of another CPE article is to provide a mathematical proof of the lack of security of Vigenere Cisco, this article focus on how to extract the exact source code (decompilation) of the viginere Cisco hash algorithm present in the routers.</p><p>In this tutorial, we will see how to decompile Packet Tracer to read the source code of a vulnerable hash algorithm to then break it.</p><h2 id=i---decompiling-vigenere-cisco-hashing-algorithm>I - Decompiling vigenere cisco hashing algorithm</h2><h2 id=1-introduction>1: Introduction:</h2><p>It is the same output as we could see in <code>packet tracer</code>. Then I suggest to decompile Packet Tracer from internet instead of openning router hardware.</p><p>Let&rsquo;s read the Packet Tracer source code!</p><p>Download Packet Tracer from: <a href=https://skillsforall.com/resources/lab-downloads>https://skillsforall.com/resources/lab-downloads</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo dpkg -i Packet_Tracer821_amd64_signed_ab5472da4e.deb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ which packettracer
</span></span><span style=display:flex><span>/usr/local/bin/packettracer
</span></span></code></pre></div><p>Find the file <code>PacketTracer</code> with: <code>ls /opt/pt/bin</code>.</p><p>The file <code>packettracer</code> provides running commands:</p><pre tabindex=0><code>$ cat /usr/local/bin/packettracer
#!/bin/bash

echo Starting Packet Tracer 8.2.1

PTDIR=/opt/pt
export LD_LIBRARY_PATH=/opt/pt/bin
pushd /opt/pt/bin &gt; /dev/null
./PacketTracer &#34;$@&#34; &gt; /dev/null 2&gt;&amp;1
popd &gt; /dev/null
</code></pre><p>Run the command <code>packettracer</code>. Create a virtual router and then run the following commands:</p><pre tabindex=0><code>Would you like to enter the initial configuration dialog? [yes/no]: n


Press RETURN to get started!



Router&gt;
Router&gt;enable
Router#configure terminal
Enter configuration commands, one per line.  End with CNTL/Z.
Router(config)#enable password mon_mot_de_passe
Router(config)#line vty 0 4
Router(config-line)#password mon_mot_de_passe
Router(config-line)#login
Router(config-line)#
Router(config-line)#service password-encryption
Router(config)#exit
Router#show run | include password
%SYS-5-CONFIG_I: Configured from console by console

service password-encryption
enable password 7 082C434036140A032D0F093B3A2A373B36
 password 7 082C434036140A032D0F093B3A2A373B36
Router#
</code></pre><p>In any cisco router you could run as well. It fits with the output of the program.</p><p>In order to redo same commands as me you could also download it from my repository</p><pre tabindex=0><code>wget https://github.com/gogo2464/packet-tracer-linux-8.2.1.0118-archive/releases/download/packet-tracer-linux-8.2.1.0118/pt.tar
tar -xvf pt.tar
cd pt.tar
cd pt
</code></pre><h3 id=21-static-analysis-looking-for-symbols-exercice>2.1: static analysis: looking for symbols (exercice)</h3><p>The next command allow you to read the Packet Tracer program disassembly.</p><pre tabindex=0><code>PTDIR=&#34;$(pwd)/pt/&#34;
export LD_LIBRARY_PATH=&#34;$(pwd)/pt/bin/&#34;
radare2 -a x86 -b 64 -A ./pt/bin/PacketTracer
</code></pre><h2 id=211-exercise>2.1.1: exercise:</h2><p>In radare2, try to find the functions where is defined to source code of the vigenere Cisco hashing algorithm.</p><h3 id=22-static-analysis-looking-for-symbols>2.2 static analysis: looking for symbols</h3><p>In a terminal, run:</p><pre tabindex=0><code>PTDIR=&#34;$(pwd)/pt/&#34;
export LD_LIBRARY_PATH=&#34;$(pwd)/pt/bin/&#34;
radare2 -a x86 -b 64 -A ./pt/bin/PacketTracer
</code></pre><p>Developpers always need to debug their code to fix bug. Sometimes, the developpers ignore or forget to remove the &ldquo;debug mode&rdquo; of their compilation tool. This situation allow a reverse engineer to make reverse engineering more easily.</p><p>Packet Tracer contains symbols and then can be reversed more easily.</p><pre tabindex=0><code>&gt; f~LineCon.password_type7
0x019396c0 1 method.CommandSet::Common::LineCon.password_type7_std::vector_std::__cxx11::basic_string_char__std::char_traits_char___std::allocator_char_____std::allocator_std::__cxx11::basic_string_char__std::char_traits_char___std::allocator_char_________CommandSet:
</code></pre><p>At this moment, let&rsquo;s jump to <code>0x019396c0</code> to analyze the code of the command related to <code>type7</code> hashing:</p><pre tabindex=0><code>s method.CommandSet::Common::LineCon.password_type7_std::vector_std::__cxx11::basic_string_char__std::char_traits_char___std::allocator_char_____std::allocator_std::__cxx11::basic_string_char__std::char_traits_char___std::allocator_char_________CommandSet:
</code></pre><pre tabindex=0><code>pd 895 @ sym.Util::encryptType7_char_const__char__unsigned_int_
</code></pre><p>Let&rsquo;s move directly to</p><pre tabindex=0><code>radare2 -a x86 -b 64 -s sym.Util::encryptType7_char_const__char__unsigned_int_ /opt/pt/bin/PacketTracer
</code></pre><h3 id=223-looking-to-with-the-help-of-dynamic-analysis>2.2.3: Looking to with the help of dynamic analysis</h3><h3 id=2231-obtain-the-hardcoded-password>2.2.3.1: Obtain the hardcoded password</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>PTDIR<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span><span style=color:#e6db74>/pt/&#34;</span>
</span></span><span style=display:flex><span>export LD_LIBRARY_PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span><span style=color:#e6db74>/pt/bin/&#34;</span>
</span></span><span style=display:flex><span>gdbserver localhost:2345 pt/bin/PacketTracer
</span></span></code></pre></div><p>From another terminal:</p><pre tabindex=0><code>radare2 -a x86 -b 64 -c &#34;dc&#34; -s sym.Util::encryptType7_char_const__char__unsigned_int_ -e dbg.exe.path=pt/bin/PacketTracer -d gdb://localhost:2345
</code></pre><p>Now from Packet Tracer GUI, open a terminal in a router and type:</p><pre tabindex=0><code>enable
configure terminal
enable password mon_mot_de_passe
line vty 0 4
password mon_mot_de_passe
login

service password-encryption
exit
show run | include password
</code></pre><h2 id=ii---reversing-the-checksum-method-by-full-reverse-engineering>II - Reversing the checksum, method by full reverse engineering</h2><h3 id=1---introduction>1 - Introduction</h3><p>We could see where the password is used:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/r method.Util.decryptType7_char_const__char__unsigned_int_
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>method.CommandSet::CTerminalLine.getDecryptedPassword_abi:cxx11____const 0x2f242ca <span style=color:#f92672>[</span>CALL<span style=color:#f92672>]</span> call 0x38fdede
</span></span><span style=display:flex><span>method.Device::CCiscoDevice.getPasswordOfUser_std::__cxx11::basic_string_char__std::char_traits_char___std::allocator_char____ 0x2ff8d2f <span style=color:#f92672>[</span>CALL<span style=color:#f92672>]</span> sub dword <span style=color:#f92672>[</span>rax<span style=color:#f92672>]</span>, <span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>It seems that this is where the checksum is compared.</p><h3 id=2---understanding-the-code>2 - Understanding the code</h3><p>While looking for in the code we found an unbelievable finding. After executing the command: <code>pd 310 @ sym.Util::decryptType7_char_const__char__unsigned_int_</code>.</p><p>With the commands:</p><pre tabindex=0><code>f~decryptType7
0x038a9d90 310 sym.Util::decryptType7_char_const__char__unsigned_int_
0x038a9d90 1 method.Util.decryptType7_char_const__char__unsigned_int_
</code></pre><p>We realize that the function does not compare two hashes together but reverse itself the hash and then compare 2 unmodified text values (plain text). We are now going to rewrite the hashing function, decompile it, recompile it in C.</p><p>The program seems to have been coded by hand in assembly language or maybe has been modified by automatic tools after compilation to make the reading harder to copyright infringers.</p><p>We are then going to position at the position in the file (offset) at <code>0x038a9e04</code> bytes from the start of the file and to define there in order to allow radare2 to print a graph with the command: <code>af @ 0x038a9e04</code>. We are now in capacity to understand the flow with the command <code>VV</code> at this offset.</p><p>After a raw conversion from assembly to C, the exact assembly logic is:</p><h3 id=211-exercise-1>2.1.1 exercise:</h3><p>Rewrite the function with name <code>method.Util.decryptType7_char_const__char__unsigned_int_</code> at offset <code>0x038a9e04</code> in C.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstring&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;ctype.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdio&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> x_lat[<span style=color:#ae81ff>41</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dsfd;kfoA,.iyewrkldJKDHSUBsgvca69834ncxv&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>decrypt_with_vigenere</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> hash, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> out_original_password, <span style=color:#66d9ef>int</span> size) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Reverse the vigenere cisco hash using the decompilation of Packet Tracer.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Returns 0 (error) if the hash size is 1 character.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Argument 1, hash: input of the hash that needs to be reversed.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Argument 2, out_original_password: reversed password output.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Argument 3, size: size in bytes of the output password from the variable out_original_password. 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Returns: 0 in case of error:
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - Returns 0 (error) if the hash size is 1 character.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - Returns 0 (error) if the second character - 0x30 has the value 9.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Returns 1 in case of success.
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> s <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(hash);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ((hash[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x30</span>) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x9</span>) { <span style=color:#75715e>// strcpy(var, atoi(hash+1)); if (var &gt; 0x9) {} // or if (hash[1] &gt; &#39;8&#39;) {}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ((hash[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x30</span>) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x9</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (((hash[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> ((hash[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>*</span><span style=color:#ae81ff>5</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span>)) <span style=color:#f92672>-</span> <span style=color:#ae81ff>528</span>) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0xf</span> ) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*if ((hash[1] + (((hash[1] - 0x30) + (hash[1] - 0x30)) * 4 ) * 2 - 0x210 ) &gt; 0xf ) {
</span></span></span><span style=display:flex><span><span style=color:#75715e>        return 0;
</span></span></span><span style=display:flex><span><span style=color:#75715e>    }*/</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> edx <span style=color:#f92672>=</span> hash[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> esi <span style=color:#f92672>=</span> edx <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x30</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (esi <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>9</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> edi <span style=color:#f92672>=</span> hash[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x30</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    esi <span style=color:#f92672>=</span> esi <span style=color:#f92672>+</span> esi <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>    esi <span style=color:#f92672>=</span> edx <span style=color:#f92672>+</span> esi <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> r15 <span style=color:#f92672>=</span> edx <span style=color:#f92672>+</span> esi <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    r15 <span style=color:#f92672>-=</span> <span style=color:#ae81ff>0x210</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    r15 <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    r15 <span style=color:#f92672>=</span> r15 <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    r15 <span style=color:#f92672>-=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (r15 <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0xf</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    r15 <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    s <span style=color:#f92672>++</span>; <span style=color:#75715e>// weird
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    s <span style=color:#f92672>=</span> s <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    s <span style=color:#f92672>-=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (s <span style=color:#f92672>&gt;</span> size) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(hash);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (s <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>        out_original_password[size] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> char_output <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> mysterious_variable2;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> mysterious_variable3 <span style=color:#f92672>=</span> r15;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>, j <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>, k <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, o <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> s <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>; i<span style=color:#f92672>++</span>, k <span style=color:#f92672>++</span>, o <span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ((i <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) { <span style=color:#75715e>//OOP: i % 2 == 0 ?
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                char_output <span style=color:#f92672>^=</span> (x_lat[j]);
</span></span><span style=display:flex><span>                out_original_password[((i<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> char_output;
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                j <span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        char_output <span style=color:#f92672>=</span> char_output <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>        mysterious_variable2 <span style=color:#f92672>=</span> <span style=color:#a6e22e>toupper</span>(hash[i]) <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x30</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (mysterious_variable2 <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0x9</span>) {<span style=color:#75715e>// if toupper(hash[i]) - 0x30 &lt;= &#39;9&#39;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            char_output <span style=color:#f92672>+=</span> mysterious_variable2;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            mysterious_variable3 <span style=color:#f92672>=</span> (hash[i] <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x41</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ((mysterious_variable3 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x5</span>)) { <span style=color:#75715e>// if (hash[i] == &#39;E&#39;) {}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>!=</span> s) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>+=</span> hash[i];
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>-=</span> <span style=color:#ae81ff>0x37</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    out_original_password[s] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;<span style=color:#75715e>//[((s+1) &gt;&gt; 2) - 2] = &#39;\0&#39;;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=221-exercise>2.2.1 exercise:</h3><p>Refactor the code with real variable names and clean structures such as: if/while/for/etc.. (control flow)</p><h3 id=222-exercise>2.2.2 exercise:</h3><p>We now are able to clean the code. It outs mainly that the first code part is always equals to 8. We are then now refactoring the source code with register <code>r15</code> in favor of <code>j</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>r15 <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>;
</span></span></code></pre></div><p>Becomes <code>j = 8</code> in:</p><pre tabindex=0><code>for (int i = 2, j = 8, k = 0, o = 0; i &lt; s + 1; i++, k ++, o ++) {
</code></pre><p>In the same way that following the code logic:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (((s<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>) <span style=color:#f92672>&gt;</span> size) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>Becomes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    s <span style=color:#f92672>++</span>; <span style=color:#75715e>// weird
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    s <span style=color:#f92672>=</span> s <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    s <span style=color:#f92672>-=</span> <span style=color:#ae81ff>2</span>;
</span></span></code></pre></div><p>We are now going to proceed to a sementical analysis in order to refactor deeper the code. For this, let&rsquo;s understand deeply the code:</p><p>The next line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>if</span> ((i <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span></code></pre></div><p>Seems to serve to return 0 one time on 2. It is a kind of half counter that is true only 1/2 times when the while is iterating. This comes either from an optimization by the compiler, from an obfuscation by an anti-piracy/industrial espionage/reverse engineering method in general or simply from an inexperienced developer who would have coded this function manually in assembly. This is an unnecessarily complicated logic to read for developers and cryptanalysts. We will then replace it with a modulo such as:</p><pre tabindex=0><code>if ((i % 2) == 0) {
</code></pre><p>There subsist trough the risk that the code logic is altered by the reverse engineeing refactoring. Let&rsquo;s create some unit tests:</p><h3 id=231-exercise>2.3.1 exercise:</h3><p>Code unit test to ensure you did not corrupted the memory yet.</p><h3 id=231-coding-unit-tests>2.3.1 Coding Unit tests:</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstring&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;../includes/cisco_decryptor.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>hash <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;08701E1D5D4C53404A52&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>password <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>) <span style=color:#a6e22e>malloc</span> (<span style=color:#a6e22e>strlen</span>(hash)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>decrypt_with_vigenere</span>(hash, password, <span style=color:#ae81ff>0x400</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;original password: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, password);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>hash2 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;08701E1D5D4C53404A5254537C7E707B616472465243&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>password2 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>) <span style=color:#a6e22e>malloc</span> (<span style=color:#a6e22e>strlen</span>(hash2)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>decrypt_with_vigenere</span>(hash2, password2, <span style=color:#ae81ff>0x400</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;original password2: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, password2);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>hash3 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0829494205163A0E1D1E&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>password3 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>) <span style=color:#a6e22e>malloc</span> (<span style=color:#a6e22e>strlen</span>(hash3)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>decrypt_with_vigenere</span>(hash3, password3, <span style=color:#ae81ff>0x400</span>) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;original password3: %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, password3);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>main.c</p><pre tabindex=0><code>$ ./src/main 
original password: 123456789
original password2: 123456789876543210555
original password3: hello_you
</code></pre><p>Excellent! Since we have this output, we know that the code has not been altered by the analysis. Let&rsquo;s continue!</p><h3 id=241-exercise>2.4.1 exercise:</h3><p>Rewrite <code>((i+1)>>1)-2</code> to more readable way.</p><h3 id=242-refactoring-i11-2>2.4.2 refactoring <code>((i+1)>>1)-2</code></h3><p>An mysterious iterator <code>((i+1)>>1)-2</code> is present at the line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>out_original_password[((i<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>] <span style=color:#f92672>=</span> char_output;
</span></span></code></pre></div><p>Thanks to debugging, we know that it corresponds to the iteration between 0 to the full checksum size typed.</p><p>It calculate <code>i</code> and iterate from 0 starting from the 3 of <code>i</code>. We are then now going to replace it by:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>out_original_password[o] <span style=color:#f92672>=</span> char_output;
</span></span></code></pre></div><p>As:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>int</span> o <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>, j <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>, k <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> s <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ((i <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>^=</span> x_lat[j];
</span></span><span style=display:flex><span>                out_original_password[o] <span style=color:#f92672>=</span> char_output;
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                j <span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>                o <span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>Decompiled line by line the code is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>mysterious_variable3 <span style=color:#f92672>=</span> (hash[i] <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x41</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ((mysterious_variable3 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x5</span>)) {
</span></span></code></pre></div><p>This is then a code verification to ensure that the entry hash <code>hash[i]</code> is superior to <code>0x46</code> that provide F for a computer when the computer compares a number of characters (in ascii).</p><p>It then means that the program verifies that the hash has characters in the interval <code>0123456789abcdef</code>, then any characters in the previous list (in hexadecimal) because the <code>type7</code> cannot contain non-hexadecimal characters. Inputting an entry outside of these values would trigger an error and the program exits in such case.</p><p>I am also removing the:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (i <span style=color:#f92672>!=</span> s) {
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	}
</span></span></code></pre></div><p>This code is useless because the buffer always has the same size&mldr;</p><p>We still could split this code and the loop in two functions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#66d9ef>char</span> char_output <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> mysterious_variable2;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> o <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>, j <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>, k <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> s <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>            char_output <span style=color:#f92672>=</span> char_output <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>            mysterious_variable2 <span style=color:#f92672>=</span> <span style=color:#a6e22e>toupper</span>(hash[i]) <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x30</span>;
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (mysterious_variable2 <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0x9</span>) {
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>+=</span> mysterious_variable2;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (mysterious_variable2 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x9</span> <span style=color:#f92672>&amp;&amp;</span> (hash[i] <span style=color:#f92672>&gt;</span> <span style=color:#e6db74>&#39;F&#39;</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (mysterious_variable2 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x9</span> <span style=color:#f92672>&amp;&amp;</span> (hash[i] <span style=color:#f92672>&lt;=</span> <span style=color:#e6db74>&#39;F&#39;</span>)) {
</span></span><span style=display:flex><span>	            char_output <span style=color:#f92672>+=</span> hash[i];
</span></span><span style=display:flex><span>	            char_output <span style=color:#f92672>-=</span> <span style=color:#ae81ff>0x37</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ((i <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>^=</span> x_lat[j];
</span></span><span style=display:flex><span>                out_original_password[o] <span style=color:#f92672>=</span> char_output;
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                j <span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>                o <span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            char_output <span style=color:#f92672>=</span> char_output <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            mysterious_variable2 <span style=color:#f92672>=</span> <span style=color:#a6e22e>toupper</span>(hash[i]) <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x30</span>;
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (mysterious_variable2 <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0x9</span>) {
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>+=</span> mysterious_variable2;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (mysterious_variable2 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x9</span> <span style=color:#f92672>&amp;&amp;</span> (hash[i] <span style=color:#f92672>&gt;</span> <span style=color:#e6db74>&#39;F&#39;</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (mysterious_variable2 <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x9</span> <span style=color:#f92672>&amp;&amp;</span> (hash[i] <span style=color:#f92672>&lt;=</span> <span style=color:#e6db74>&#39;F&#39;</span>)) {
</span></span><span style=display:flex><span>	            char_output <span style=color:#f92672>+=</span> hash[i];
</span></span><span style=display:flex><span>	            char_output <span style=color:#f92672>-=</span> <span style=color:#ae81ff>0x37</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>The code becomes more readable!!</p><p>After analysis, the code part <code>mysterious_variable2 = toupper(hash[i]) - 0x30;</code> achieves to convert ascii to hexadecimal. A bit like <code>atoi</code>. We are now going to rename <code>mysterious_variable2</code> to <code>hexified_hash_ascii</code>.</p><p>I was not really understanding easily the behavior of <code>out_original_password[((s+1) >> 2) - 2]</code> and I was not able to make it run.</p><p>Anyway, from the global program internals, I see I should replace it with <code>out_original_password[o] = '\0';</code>.</p><p><code>if ((hash[1] - 0x30) > 0x9) {</code> becomes <code>if (hash[1] > '9')</code>. And <code>if ((hash[0] - 0x30) > 0x9) {</code> becomes <code>if (hash[1] > '9')</code>.</p><p>We remove <code>s = strlen(hash);</code>.</p><p>And&mldr; We finally have:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstring&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;ctype.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdio&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> x_lat[<span style=color:#ae81ff>41</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dsfd;kfoA,.iyewrkldJKDHSUBsgvca69834ncxv&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>decrypt_with_vigenere</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> hash, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> out_original_password, <span style=color:#66d9ef>int</span> size) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* Reverse the vigenere cisco hash using the decompilation of Packet Tracer.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Shift left to 4 each character, then converts each ascii hash to hexadecimal number. If the result is a number between 0-9, then the number is added to the output buffer. Else, we add this number and remove 7. 1 time on 2, the result is xored with the `x_lat` plain text password.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Argument 1, hash: input of the hash that needs to be reversed.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Argument 2, out_original_password: reversed password output.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Argument 3, size: size in bytes of the output password from the variable out_original_password. 
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Returns: 0 in case of error:
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - Returns 0 (error) if the hash size is 1 character.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - Returns 0 (error) if the first character is a letter.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - Returns 0 (error) if the second character is a letter.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - Returns 0 (error) if the hash is not an even number.
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Returns 1 in case of success.
</span></span></span><span style=display:flex><span><span style=color:#75715e>    */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> s <span style=color:#f92672>=</span> <span style=color:#a6e22e>strlen</span>(hash);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (s <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (hash[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&gt;</span> <span style=color:#e6db74>&#39;9&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (hash[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>&gt;</span> <span style=color:#e6db74>&#39;9&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (((hash[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> ((hash[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>*</span><span style=color:#ae81ff>5</span>)<span style=color:#f92672>*</span><span style=color:#ae81ff>2</span>)) <span style=color:#f92672>-</span> <span style=color:#ae81ff>528</span>) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0xf</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ((((s<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>&gt;&gt;</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>) <span style=color:#f92672>&gt;</span> size) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> char_output <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> hexified_ascii_hash;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> o <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>, j <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>; i <span style=color:#f92672>&lt;</span> (s <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>); i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>            char_output <span style=color:#f92672>=</span> char_output <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>            hexified_ascii_hash <span style=color:#f92672>=</span> <span style=color:#a6e22e>toupper</span>(hash[i]) <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x30</span>;
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (hexified_ascii_hash <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0x9</span>) {
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>+=</span> hexified_ascii_hash;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (hexified_ascii_hash <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x9</span> <span style=color:#f92672>&amp;&amp;</span> (hash[i] <span style=color:#f92672>&gt;</span> <span style=color:#e6db74>&#39;F&#39;</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (hexified_ascii_hash <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x9</span> <span style=color:#f92672>&amp;&amp;</span> (hash[i] <span style=color:#f92672>&lt;=</span> <span style=color:#e6db74>&#39;F&#39;</span>)) {
</span></span><span style=display:flex><span>	            char_output <span style=color:#f92672>+=</span> hash[i];
</span></span><span style=display:flex><span>	            char_output <span style=color:#f92672>-=</span> <span style=color:#ae81ff>0x37</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (i <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> ((i <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>^=</span> x_lat[j];
</span></span><span style=display:flex><span>                out_original_password[o] <span style=color:#f92672>=</span> char_output;
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                j <span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>                o <span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            char_output <span style=color:#f92672>=</span> char_output <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>            hexified_ascii_hash <span style=color:#f92672>=</span> <span style=color:#a6e22e>toupper</span>(hash[i]) <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x30</span>;
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (hexified_ascii_hash <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0x9</span>) {
</span></span><span style=display:flex><span>                char_output <span style=color:#f92672>+=</span> hexified_ascii_hash;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (hexified_ascii_hash <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x9</span> <span style=color:#f92672>&amp;&amp;</span> (hash[i] <span style=color:#f92672>&gt;</span> <span style=color:#e6db74>&#39;F&#39;</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (hexified_ascii_hash <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0x9</span> <span style=color:#f92672>&amp;&amp;</span> (hash[i] <span style=color:#f92672>&lt;=</span> <span style=color:#e6db74>&#39;F&#39;</span>)) {
</span></span><span style=display:flex><span>	            char_output <span style=color:#f92672>+=</span> hash[i];
</span></span><span style=display:flex><span>	            char_output <span style=color:#f92672>-=</span> <span style=color:#ae81ff>0x37</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    out_original_password[o] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;\0&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Excellent! We are now able to study it! We are going to see the mathematical implication that follows that in <a href=there>the next article that focuses on mathematical proofs and logic a</a>.</p><h3 id=iii-reverse-engineering-the-code>III/ Reverse-engineering the code:</h3><h2 id=1---exercise>1 - exercise</h2><p>reverse the Vigenere Cisco encryption algorithm.</p><h2 id=next>next</h2><p>By digging, we realize, it is not mandatory the recode ourself the code of the new algorithm. In effect, the command <code>pd 310 @ sym.Util::decryptType7_char_const__char__unsigned_int_</code> of radare2 already contains the revesing of the checksum of Vigenere Cisco in Packet Tracer&mldr;</p><p>Vigenere Cisco algorithm has two main weaknesses:</p><ul><li>The algorithm does not compare two changed values (hashed) together but quickly reverse it own algorithm to compare 2 unchanged texts.</li><li>The algorithm contains a password to change and revert to the changes in its own algorithm. This is a weakness. Ensure by checking <code>Kerckhoffs</code> principle online.</li></ul><h2 id=ressources>Ressources</h2><p>Documentation for Packet Tracer commands:</p><ul><li><a href=https://media.defense.gov/2022/Feb/17/2002940795/-1/-1/1/CSI_CISCO_PASSWORD_TYPES_BEST_PRACTICES_20220217.PDF>https://media.defense.gov/2022/Feb/17/2002940795/-1/-1/1/CSI_CISCO_PASSWORD_TYPES_BEST_PRACTICES_20220217.PDF</a></li><li><a href=https://cisco.goffinet.org/ccna/gestion-infrastructure/chiffrement-des-mots-de-passes-locaux-cisco-ios/>https://cisco.goffinet.org/ccna/gestion-infrastructure/chiffrement-des-mots-de-passes-locaux-cisco-ios/</a></li><li><a href=https://www.oreilly.com/library/view/hardening-cisco-routers/0596001665/ch04.html>https://www.oreilly.com/library/view/hardening-cisco-routers/0596001665/ch04.html</a></li></ul><p>wrong recopy of vigenere cisco. It prooves the need for this article:</p><ul><li><a href=https://github.com/theevilbit/ciscot7/blob/master/ciscot7.py>https://github.com/theevilbit/ciscot7/blob/master/ciscot7.py</a></li></ul></div></article><hr><div class=post-info></div></main></div><footer class=footer><div class=footer__inner><ul class=icons><li><a href=https://gogo2464.github.io/gogo-s-blog-cpe/posts/index.xml target=_blank title=rss class="icon fa-solid fa-rss"></a></li></ul></div><div class=footer__inner><span>&copy;2024</span>&nbsp;
<span><a href=https://gogo2464.github.io/gogo-s-blog-cpe/></a></span>&nbsp;
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span><span>with <a href=https://github.com/coolapso/hugo-theme-hello-4s3ti>Hello-friend-4s3ti</a></span></div></div></footer></div><script type=text/javascript src=/gogo-s-blog-cpe/bundle.min.efa6b6352b1e4d712533d2fbd29f0c899eb1474e0f181433c934e6c6fdd3678ff834c116423c957d7a6ff6763e9c0d599a82208cdeae81c4a483e37853c46360.js integrity="sha512-76a2NSseTXElM9L70p8MiZ6xR04PGBQzyTTmxv3TZ4/4NMEWQjyVfXpv9nY+nA1ZmoIgjN6ugcSkg+N4U8RjYA=="></script></body></html>